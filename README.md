# Quasimodo

Automating some NodeJS profiling/load-testing so I have more time for shenanigans

## Dependencies

- loadtest
- stackvis
- TBD

## Sample Usage (TBD)

```js

// quasimodo-test.js

const quasimodo = require('quasimodo');

// register test(s) with identifying name, path_to_file and args_and_flags
quasimodo.registerTest('TEST_ONE', './server.js', '--turbo --max_inlined_source_size=700');
quasimodo.registerTest('TEST_TWO', './bench.js', '--turbo --max_inlined_source_size=700');

// configure test output options
quasimodo.configure({
  loadtest: {
    post: '$TEST_FILE',
    type: 'application/json',
    concurrency: 8, 
    requests: 500, 
    target: 'http://localhost:8080/some_end_point'
  },
  output: './results.txt', // default: './results.txt'
});

// run these commands once before all tests start
quasimodo.before(['TEST_FILE=/tmp/big-text.json', 'cat test/fixtures/big-text.txt | jq -rM "{text: .}" > $TEST_FILE']);

// run these commands once after all tests complete
quasimodo.after(['echo DONE']);

// run these commands (comma separated) before each registered test
quasimodo.beforeEach(['echo RUNNING $$TEST_NAME']); // double $$ refers to test-global variables

// run these commands (comma separated) after each registered test
quasimodo.afterEach(['echo FINISHING $TEST_NAME']);

// run all tests
quasimodo.run();
```

What the following test file will show as in the terminal:

```
$ node quasimodo-test

Tests registered: 2 ...

Running all tests ...

Running pre-test tasks ...

RUNNING TEST_ONE
<some output generated by target scripts>
FINISHING TEST_ONE
 
RUNNING TEST_TWO
<some output generated by target script>
FINISHING TEST_TWO

DONE 
```

This should have generated:

- Plaintext `results.txt` with test stats
- Graph of CPU usage per test
- Graph of Memory usage per test
- Stackvis SVG of CPU usage for each function call (v8)

## GLOBAL VARIABLES (accessed by `'$$'`)

$$TEST_NAMES = 'string, of, test, names'
$$TEST_NAME  = 'current_test_name'

## Quasimodo##configure(options = {})

Available options:

#### loadtest (By default is disabled)
```
loadtest: '-c 8 -n 500 -p $TEST_FILE -T application/json http://localhost:3000/end_point'

.... OR ....

// These are the only params you can pass if you use an object
loadtest: {
  concurrency: 8,
  requests: 500,
  post: '$TEST_FILE',
  type: 'application/json',
  target: 'http://localhost:3000/endpoint'
}

```
#### output (Default: ./results.txt)

Specify the file name for all test results


## Quasimodo##registerTest(name, path_to_script, arguments_and_flags)

Register the NodeJS process to run as part of the test group


## Quasimodo##before(['COMMAND_ONE, 'COMMAND_TWO', 'COMMAND_THREE'])

An order-sensitive list of commands to run before running all the tests


## Quasimodo##after(['COMMAND_ONE, 'COMMAND_TWO', 'COMMAND_THREE'])

An order-sensitive list of commands to run after all tests finish running


## Quasimodo##beforeEach(['COMMAND_ONE, 'COMMAND_TWO', 'COMMAND_THREE'])

An order-sensitive list of commands to run before running each test


## Quasimodo##afterEach(['COMMAND_ONE, 'COMMAND_TWO', 'COMMAND_THREE'])

An order-sensitive list of commands to run after each test runs


